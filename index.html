<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>XpenseFlow Pro</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIlhwZW5zZUZsb3ciLAogICJzaG9ydF9uYW1lIjogIlhwZW5zZUZsb3ciLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI0YwRjJGNSIsCiAgInRoZW1lX2NvbG9yIjogIiMxRTQwQUYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2lrLmltYWdla2l0LmlvLzEzcGNtcXF6bi8xMDAwMTY5MjM5LXJlbW92ZWJnLXByZXZpZXclMjAoMSkucG5nP3VwZGF0ZWRBdD0xNzY4MzQ5OTUzMTQ0IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#F0F2F5" />
    <link rel="icon" type="image/png" href="https://ik.imagekit.io/13pcmqqzn/1000169239-removebg-preview%20(1).png?updatedAt=1768349953144" />

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js" crossorigin="anonymous"></script>

    <style>
        /* Light & Dark Mode Variables */
        :root {
            --bg: #F0F2F5;
            --text-main: #1A1C2E;
            --text-sub: #9CA3AF;
            --shadow-light: #FFFFFF;
            --shadow-dark: #D1D9E6;
            --blue: #1E40AF;
            --green: #10B981;
            --red: #EF4444;
            --glass: rgba(240, 242, 245, 0.9);
        }
        body.dark {
            --bg: #212529;
            --text-main: #E0E0E0;
            --text-sub: #6C757D;
            --shadow-light: #2c3035;
            --shadow-dark: #16191c;
            --glass: rgba(33, 37, 41, 0.9);
        }

        /* Core Reset */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; user-select: none; }
        body { background-color: var(--bg); color: var(--text-main); font-family: 'Inter', sans-serif; min-height: 100dvh; width: 100vw; overflow: hidden; position: fixed; margin: 0; transition: background-color 0.3s; }
        #root { height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Neumorphic Design System */
        .neu-flat { background: var(--bg); box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light); border-radius: 24px; border: 1px solid rgba(255,255,255,0.05); transition: all 0.3s; }
        .neu-pressed { background: var(--bg); box-shadow: inset 6px 6px 12px var(--shadow-dark), inset -6px -6px 12px var(--shadow-light); border-radius: 20px; transition: all 0.3s; }
        .neu-btn { background: var(--bg); box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light); border-radius: 16px; transition: all 0.2s ease; cursor: pointer; }
        .neu-btn:active { box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light); transform: scale(0.98); }
        .neu-icon { background: linear-gradient(145deg, var(--shadow-light), var(--bg)); box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light); border-radius: 16px; }
        
        /* Specialized UI */
        .fab-main { background: var(--blue); box-shadow: 0 10px 25px rgba(30, 64, 175, 0.4); border: 6px solid var(--bg); transform: translateY(-24px); }
        .frosted-nav { background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); padding-bottom: env(safe-area-inset-bottom); }
        .blur-sensitive { filter: blur(8px); transition: filter 0.3s; }
        .pulse-alert { animation: pulse-red 2s infinite; border: 1px solid var(--red); }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        /* Circular Progress */
        .circular-chart { display: block; margin: 0 auto; max-width: 80%; max-height: 250px; }
        .circle-bg { fill: none; stroke: var(--bg); stroke-width: 3.8; }
        .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; animation: progress 1s ease-out forwards; }
        @keyframes progress { 0% { stroke-dasharray: 0 100; } }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .page-enter { animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Gemini SDK -->
    <script type="module">
        import { GoogleGenAI } from 'https://esm.run/@google/genai';
        window.GoogleGenAI = GoogleGenAI;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONFIGURATION ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBhUgvyYF_6BJkexyQvCSCCC8wev8Cnxbw",
            authDomain: "kids-d0256.firebaseapp.com",
            projectId: "kids-d0256",
            storageBucket: "kids-d0256.appspot.com",
            messagingSenderId: "975392531560",
            appId: "1:975392531560:web:7b165f696b1bdc8f57f47dd"
        };
        
        // Initialize Firebase safely
        try {
            if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        } catch (e) {
            console.error("Firebase init error", e);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        db.enablePersistence().catch(() => {});

        const LOGO = "https://ik.imagekit.io/13pcmqqzn/1000169239-removebg-preview%20(1).png?updatedAt=1768349953144";
        const CATEGORIES = ["Food", "Transport", "Shopping", "Bills", "Entertainment", "Health", "Investment", "Salary", "Subscription", "Other"];
        const RATES = { USD: 1, EUR: 0.92, GBP: 0.79, INR: 83.5, JPY: 150 };
        const SYMBOLS = { USD: '$', EUR: '€', GBP: '£', INR: '₹', JPY: '¥' };

        // --- SUB-COMPONENTS ---

        const Shimmer = () => (
            <div className="p-6 space-y-6 h-full flex flex-col justify-center animate-pulse">
                <div className="h-48 neu-flat rounded-3xl w-full bg-gray-200 dark:bg-gray-800 opacity-50"></div>
                <div className="flex gap-4 w-full">
                    <div className="flex-1 h-32 neu-flat rounded-3xl bg-gray-200 dark:bg-gray-800 opacity-50"></div>
                    <div className="flex-1 h-32 neu-flat rounded-3xl bg-gray-200 dark:bg-gray-800 opacity-50"></div>
                </div>
            </div>
        );

        const PinScreen = ({ onUnlock }) => {
            const [pin, setPin] = useState(['','','','']);
            const inputs = useRef([]);

            const handleInput = (v, i) => {
                const newPin = [...pin];
                newPin[i] = v;
                setPin(newPin);
                if(v && i < 3 && inputs.current[i+1]) inputs.current[i+1].focus();
                if(newPin.join('').length === 4) onUnlock(newPin.join(''));
            };

            return (
                <div className="fixed inset-0 z-[100] bg-[var(--bg)] flex flex-col items-center justify-center p-8 page-enter">
                    <div className="w-20 h-20 neu-icon rounded-2xl flex items-center justify-center mb-8 text-[var(--blue)] text-3xl">
                        <i className="fas fa-lock"></i>
                    </div>
                    <h2 className="text-2xl font-black mb-8 text-[var(--text-main)]">Security Lock</h2>
                    <div className="flex gap-4">
                        {[0,1,2,3].map(i => (
                            <input key={i} ref={el => inputs.current[i] = el} type="password" maxLength="1"
                                className="w-12 h-16 neu-pressed text-center text-2xl font-black bg-transparent outline-none rounded-xl text-[var(--text-main)]"
                                value={pin[i]} onChange={e => handleInput(e.target.value, i)}
                            />
                        ))}
                    </div>
                </div>
            );
        };

        const InsightBubble = ({ transactions }) => {
            const [insight, setInsight] = useState(null);
            
            useEffect(() => {
                if(!window.GoogleGenAI || transactions.length < 3) return;
                const runAI = async () => {
                    try {
                        const total = transactions.reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);
                        const topCat = transactions[0]?.category || 'General';
                        const ai = new window.GoogleGenAI({ apiKey: process.env.API_KEY });
                        const res = await ai.models.generateContent({
                            model: 'gemini-3-flash-preview',
                            contents: `Spend: ${total}. Top: ${topCat}. Give 1 short, witty financial tip (max 10 words).`
                        });
                        if (res.text) setInsight(res.text);
                    } catch(e) {
                        console.warn("AI Insight error:", e);
                    }
                };
                runAI();
            }, [transactions.length]);

            if(!insight) return null;
            return (
                <div className="mx-2 mb-4 p-4 neu-pressed rounded-xl flex items-center gap-3 animate-fade-in">
                    <div className="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-[var(--blue)]"><i className="fas fa-sparkles"></i></div>
                    <p className="text-xs font-bold text-[var(--text-sub)] italic">"{insight}"</p>
                </div>
            );
        };

        const GoalWidget = ({ goal }) => {
            const safeTarget = goal.target || 1;
            const pct = Math.min((goal.current / safeTarget) * 100, 100);
            return (
                <div className="neu-flat p-4 flex flex-col items-center justify-center relative w-full aspect-square">
                    <svg viewBox="0 0 36 36" className="circular-chart w-full h-full transform -rotate-90">
                        <path className="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" stroke="#E5E7EB" />
                        <path className="circle" strokeDasharray={`${pct}, 100`} d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" stroke={pct >= 100 ? '#10B981' : '#1E40AF'} />
                    </svg>
                    <div className="absolute flex flex-col items-center">
                        <i className={`fas fa-${pct>=100?'check':'car'} text-[var(--blue)] mb-1`}></i>
                        <span className="text-[10px] font-bold text-[var(--text-sub)] uppercase">{goal.name || 'Goal'}</span>
                        <span className="text-xs font-black">{Math.round(pct)}%</span>
                    </div>
                </div>
            );
        };

        // --- MAIN VIEWS ---

        const Dashboard = ({ user, transactions, settings, goals, setView }) => {
            const rate = RATES[settings.currency] || 1;
            const symbol = SYMBOLS[settings.currency] || '$';
            
            const stats = useMemo(() => transactions.reduce((acc, t) => {
                const val = parseFloat(t.amount) || 0;
                if (t.type === 'INCOME') { acc.inc += val; acc.total += val; }
                else { acc.exp += val; acc.total -= val; }
                return acc;
            }, { inc: 0, exp: 0, total: 0 }), [transactions]);

            const safeBudget = settings.budget || 1;
            const budgetPct = Math.min((stats.exp / safeBudget) * 100, 100);
            const isAlert = budgetPct > 80;

            return (
                <div className="space-y-6 page-enter pb-24">
                    {/* Header */}
                    <div className="flex justify-between items-center px-2">
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 neu-icon rounded-2xl flex items-center justify-center">
                                <img src={LOGO} className="w-7 h-7 object-contain" />
                            </div>
                            <div>
                                <h1 className="text-xl font-black text-[var(--blue)]">XpenseFlow</h1>
                                <p className="text-[10px] font-bold text-[var(--text-sub)] uppercase tracking-widest">{settings.groupId === user.uid ? 'Personal' : 'Group Wallet'}</p>
                            </div>
                        </div>
                        <button onClick={settings.toggleStealth} className={`w-10 h-10 neu-icon rounded-full flex items-center justify-center text-[var(--text-sub)] ${settings.stealth ? 'text-[var(--blue)]' : ''}`}>
                            <i className={`fas fa-${settings.stealth ? 'eye-slash' : 'eye'}`}></i>
                        </button>
                    </div>

                    <InsightBubble transactions={transactions} />

                    {/* Net Worth */}
                    <div className="neu-flat p-8 flex flex-col items-center justify-center relative overflow-hidden">
                        <p className="text-[10px] font-bold text-[var(--text-sub)] uppercase tracking-[0.3em] mb-2">NET WORTH</p>
                        <h1 className={`text-4xl font-black text-[var(--text-main)] ${settings.stealth ? 'blur-sensitive' : ''}`}>
                            {symbol}{(stats.total * rate).toLocaleString(undefined, {maximumFractionDigits: 0})}
                        </h1>
                    </div>

                    {/* Smart Budget */}
                    <div className={`neu-flat p-6 ${isAlert ? 'pulse-alert' : ''}`}>
                        <div className="flex justify-between mb-3">
                            <span className={`text-xs font-bold uppercase ${isAlert ? 'text-[var(--red)]' : 'text-[var(--text-sub)]'}`}>{isAlert ? 'Budget Critical' : 'Monthly Budget'}</span>
                            <span className="text-xs font-black text-[var(--blue)]">{symbol}{Math.round(stats.exp * rate)} / {symbol}{Math.round(settings.budget * rate)}</span>
                        </div>
                        <div className="h-3 w-full neu-pressed rounded-full overflow-hidden">
                            <div className={`h-full transition-all duration-1000 ${isAlert ? 'bg-[var(--red)]' : 'bg-[var(--blue)]'}`} style={{width: `${budgetPct}%`}}></div>
                        </div>
                    </div>

                    {/* Quick Stats Grid */}
                    <div className="grid grid-cols-2 gap-5">
                        <div className="neu-flat p-5 flex flex-col items-center">
                            <span className="text-[10px] font-bold text-[var(--text-sub)] uppercase">Income</span>
                            <span className={`text-lg font-black text-[var(--green)] ${settings.stealth ? 'blur-sensitive' : ''}`}>+{symbol}{(stats.inc * rate).toLocaleString()}</span>
                        </div>
                        <div className="neu-flat p-5 flex flex-col items-center">
                            <span className="text-[10px] font-bold text-[var(--text-sub)] uppercase">Expense</span>
                            <span className={`text-lg font-black text-[var(--red)] ${settings.stealth ? 'blur-sensitive' : ''}`}>-{symbol}{(stats.exp * rate).toLocaleString()}</span>
                        </div>
                    </div>

                    {/* Goals & Subs Teaser */}
                    <div className="grid grid-cols-3 gap-4">
                        {goals.slice(0, 2).map(g => <GoalWidget key={g.id} goal={g} />)}
                        <button onClick={()=>setView('subscriptions')} className="neu-flat p-2 flex flex-col items-center justify-center text-[var(--text-sub)] active:scale-95">
                            <i className="fas fa-file-invoice-dollar text-xl mb-1 text-[var(--blue)]"></i>
                            <span className="text-[9px] font-bold uppercase text-center">Fixed<br/>Costs</span>
                        </button>
                    </div>
                </div>
            );
        };

        const SubscriptionView = ({ subscriptions, onAdd, onDelete, settings }) => {
            const [name, setName] = useState('');
            const [cost, setCost] = useState('');
            const symbol = SYMBOLS[settings.currency] || '$';
            const rate = RATES[settings.currency] || 1;
            const total = subscriptions.reduce((s, sub) => s + (parseFloat(sub.amount) || 0), 0);

            return (
                <div className="space-y-6 page-enter pb-32">
                    <h2 className="text-2xl font-black text-[var(--blue)] px-2">Subscriptions</h2>
                    
                    <div className="neu-flat p-6 flex justify-between items-center">
                        <span className="font-bold text-[var(--text-sub)] uppercase text-xs">Monthly Fixed</span>
                        <span className={`text-2xl font-black text-[var(--text-main)] ${settings.stealth ? 'blur-sensitive' : ''}`}>{symbol}{(total * rate).toFixed(2)}</span>
                    </div>

                    <div className="space-y-4">
                        {subscriptions.map(s => (
                            <div key={s.id} className="neu-flat p-4 flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-xl bg-purple-100 text-purple-600 flex items-center justify-center font-bold">{(s.name || '?')[0]}</div>
                                    <h4 className="font-bold text-[var(--text-main)]">{s.name || 'Unknown'}</h4>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className={`font-black ${settings.stealth ? 'blur-sensitive' : ''}`}>{symbol}{((parseFloat(s.amount)||0) * rate).toFixed(2)}</span>
                                    <button onClick={()=>onDelete(s.id)} className="text-[var(--text-sub)]"><i className="fas fa-trash"></i></button>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="neu-flat p-4 space-y-4">
                        <h3 className="text-xs font-bold text-[var(--text-sub)] uppercase">Add Recurring</h3>
                        <div className="flex gap-2">
                            <input placeholder="Netflix..." value={name} onChange={e=>setName(e.target.value)} className="flex-[2] p-3 neu-pressed rounded-xl bg-transparent outline-none font-bold text-[var(--text-main)]" />
                            <input type="number" placeholder="9.99" value={cost} onChange={e=>setCost(e.target.value)} className="flex-1 p-3 neu-pressed rounded-xl bg-transparent outline-none font-bold text-[var(--text-main)]" />
                        </div>
                        <button onClick={()=>{if(name&&cost) {onAdd({name, amount:parseFloat(cost)}); setName(''); setCost('');}}} className="w-full py-3 neu-btn text-[var(--blue)] font-black uppercase text-xs">Add Subscription</button>
                    </div>
                </div>
            );
        };

        const HistoryView = ({ transactions, settings, onDelete }) => {
            const [search, setSearch] = useState('');
            const symbol = SYMBOLS[settings.currency] || '$';
            const rate = RATES[settings.currency] || 1;
            
            const filtered = transactions.filter(t => 
                (t.title || '').toLowerCase().includes(search.toLowerCase()) || 
                (t.category || '').toLowerCase().includes(search.toLowerCase())
            );

            return (
                <div className="space-y-4 page-enter pb-32">
                    <div className="sticky top-0 bg-[var(--bg)] z-10 pb-2 pt-1">
                        <h2 className="text-2xl font-black text-[var(--blue)] px-2 mb-4">History</h2>
                        <div className="neu-pressed p-3 flex items-center gap-3 mx-2 rounded-xl">
                            <i className="fas fa-search text-[var(--text-sub)]"></i>
                            <input placeholder="Search transactions..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full bg-transparent outline-none font-bold text-[var(--text-main)]" />
                        </div>
                    </div>

                    {filtered.map(t => (
                        <div key={t.id} className="neu-flat p-4 flex items-center justify-between mx-2">
                            <div className="flex items-center gap-4">
                                <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-xl ${t.type === 'INCOME' ? 'bg-green-100 text-[var(--green)]' : 'bg-red-100 text-[var(--red)]'}`}>
                                    <i className={`fas ${t.type === 'INCOME' ? 'fa-arrow-down' : 'fa-shopping-bag'}`}></i>
                                </div>
                                <div>
                                    <h4 className="font-bold text-[var(--text-main)] truncate w-32">{t.title || 'Unknown'}</h4>
                                    <p className="text-[10px] font-bold text-[var(--text-sub)] uppercase">{t.category || 'General'} • {t.date ? new Date(t.date).toLocaleDateString() : 'Date?'}</p>
                                </div>
                            </div>
                            <div className="flex flex-col items-end gap-1">
                                <span className={`font-black ${t.type === 'INCOME' ? 'text-[var(--green)]' : 'text-[var(--red)]'} ${settings.stealth ? 'blur-sensitive' : ''}`}>
                                    {t.type === 'INCOME' ? '+' : '-'}{symbol}{((parseFloat(t.amount)||0) * rate).toFixed(0)}
                                </span>
                                <button onClick={()=>onDelete(t.id)} className="text-[var(--text-sub)] text-xs"><i className="fas fa-trash"></i></button>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const SettingsView = ({ settings, onUpdate, user }) => {
            const [tempPin, setTempPin] = useState('');

            return (
                <div className="space-y-6 page-enter pb-32">
                    <h2 className="text-2xl font-black text-[var(--blue)] px-2">Settings</h2>

                    <div className="neu-flat p-6 space-y-6">
                        {/* Theme */}
                        <div className="flex justify-between items-center">
                            <span className="font-bold text-[var(--text-main)]">Dark Mode</span>
                            <button onClick={()=>onUpdate({...settings, theme: settings.theme === 'light' ? 'dark' : 'light'})} className={`w-12 h-6 rounded-full relative transition-colors ${settings.theme === 'dark' ? 'bg-[var(--blue)]' : 'bg-gray-300'}`}>
                                <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${settings.theme === 'dark' ? 'right-1' : 'left-1'}`}></div>
                            </button>
                        </div>

                        {/* Currency */}
                        <div>
                            <label className="text-xs font-bold text-[var(--text-sub)] uppercase block mb-3">Currency (Simulated)</label>
                            <div className="flex gap-2">
                                {Object.keys(SYMBOLS).map(c => (
                                    <button key={c} onClick={()=>onUpdate({...settings, currency: c})} className={`flex-1 py-2 rounded-lg font-bold text-xs ${settings.currency === c ? 'neu-pressed text-[var(--blue)]' : 'text-[var(--text-sub)]'}`}>{c}</button>
                                ))}
                            </div>
                        </div>

                        {/* Group Wallet */}
                        <div>
                            <label className="text-xs font-bold text-[var(--text-sub)] uppercase block mb-3">Shared Group ID</label>
                            <input value={settings.groupId} onChange={e=>onUpdate({...settings, groupId: e.target.value})} className="w-full p-3 neu-pressed rounded-xl font-bold text-[var(--text-main)] outline-none bg-transparent" placeholder="Enter Group ID" />
                            <p className="text-[10px] text-[var(--text-sub)] mt-2">Share this ID to sync with family.</p>
                        </div>

                        {/* Security PIN */}
                        <div>
                            <label className="text-xs font-bold text-[var(--text-sub)] uppercase block mb-3">Set Security PIN</label>
                            <div className="flex gap-2">
                                <input maxLength="4" type="password" placeholder="****" value={tempPin} onChange={e=>setTempPin(e.target.value)} className="flex-[3] p-3 neu-pressed rounded-xl bg-transparent outline-none font-bold text-[var(--text-main)]" />
                                <button onClick={()=>{localStorage.setItem('xpense_pin', tempPin); alert('PIN Set!'); setTempPin('');}} className="flex-1 neu-btn text-[var(--blue)] font-bold text-xs">SAVE</button>
                            </div>
                        </div>
                    </div>
                    <button onClick={() => auth.signOut()} className="w-full py-5 neu-btn text-[var(--red)] font-black tracking-widest">LOGOUT</button>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home');
            const [loading, setLoading] = useState(true);
            const [isLocked, setIsLocked] = useState(!!localStorage.getItem('xpense_pin'));
            const [modalOpen, setModalOpen] = useState(false);
            
            // Core Data
            const [txs, setTxs] = useState([]);
            const [subscriptions, setSubscriptions] = useState([]);
            const [goals, setGoals] = useState([{id:1, name:'Car', target:5000, current:1200}, {id:2, name:'Trip', target:2000, current:1800}]); // Mock initial goals
            
            // Settings State
            const [settings, setSettings] = useState({ 
                currency: 'USD', 
                budget: 5000, 
                stealth: false, 
                theme: 'light', 
                groupId: '' 
            });

            // Input State
            const [newTitle, setNewTitle] = useState('');
            const [newAmount, setNewAmount] = useState('');
            const [newType, setNewType] = useState('EXPENSE');
            const [newCat, setNewCat] = useState('Food');
            const [aiLoading, setAiLoading] = useState(false);
            const fileRef = useRef(null);

            // Theme Effect
            useEffect(() => {
                document.body.className = settings.theme;
            }, [settings.theme]);

            // Auth & Init
            useEffect(() => {
                const unsub = auth.onAuthStateChanged(u => {
                    if(u) {
                        setUser(u);
                        setSettings(prev => ({...prev, groupId: u.uid}));
                    }
                    else setLoading(false);
                });
                return () => unsub();
            }, []);

            // Data Sync (Transactions & Subs based on GroupID)
            useEffect(() => {
                if(!user || !settings.groupId) return;
                setLoading(true);
                const collectionPath = settings.groupId === user.uid ? `users/${user.uid}` : `groups/${settings.groupId}`;
                
                const unsubTx = db.collection(collectionPath + '/transactions').orderBy('date', 'desc').onSnapshot(s => {
                    setTxs(s.docs.map(d => ({id: d.id, ...d.data()})));
                    setLoading(false);
                }, (error) => {
                    console.error("Tx sync error:", error);
                    setLoading(false);
                });

                const unsubSub = db.collection(collectionPath + '/subscriptions').onSnapshot(s => {
                    setSubscriptions(s.docs.map(d => ({id: d.id, ...d.data()})));
                }, (error) => {
                    console.error("Sub sync error:", error);
                });

                return () => { unsubTx(); unsubSub(); };
            }, [user, settings.groupId]);

            const handleAdd = async () => {
                if(!newTitle || !newAmount) return;
                const path = settings.groupId === user.uid ? `users/${user.uid}` : `groups/${settings.groupId}`;
                await db.collection(path + '/transactions').add({
                    title: newTitle, amount: parseFloat(newAmount), type: newType, category: newCat, date: new Date().toISOString()
                });
                setModalOpen(false); setNewTitle(''); setNewAmount('');
            };

            const addSub = async (sub) => {
                const path = settings.groupId === user.uid ? `users/${user.uid}` : `groups/${settings.groupId}`;
                await db.collection(path + '/subscriptions').add(sub);
            };

            const delSub = async (id) => {
                const path = settings.groupId === user.uid ? `users/${user.uid}` : `groups/${settings.groupId}`;
                await db.collection(path + '/subscriptions').doc(id).delete();
            };

            const delTx = async (id) => {
                if(!confirm('Delete item?')) return;
                const path = settings.groupId === user.uid ? `users/${user.uid}` : `groups/${settings.groupId}`;
                await db.collection(path + '/transactions').doc(id).delete();
            };

            const handleOCR = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!window.GoogleGenAI) {
                    alert("AI service not ready. Please verify connection.");
                    return;
                }

                setAiLoading(true);
                try {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = async () => {
                        try {
                            const b64 = reader.result.split(',')[1];
                            const ai = new window.GoogleGenAI({ apiKey: process.env.API_KEY });
                            const res = await ai.models.generateContent({
                                model: 'gemini-3-flash-preview',
                                contents: { parts: [
                                    { inlineData: { mimeType: file.type, data: b64 } },
                                    { text: "Extract receipt data. JSON ONLY: {merchant, amount, category}" }
                                ]},
                                config: { responseMimeType: "application/json" }
                            });
                            const data = JSON.parse(res.text);
                            setNewTitle(data.merchant || 'Unknown');
                            setNewAmount(data.amount || '');
                            if(data.category) setNewCat(data.category);
                        } catch(err) {
                            console.error("OCR Parse Error", err);
                            alert("Failed to analyze receipt");
                        }
                        setAiLoading(false);
                    };
                } catch(err) { 
                    alert("OCR Failed"); 
                    setAiLoading(false); 
                }
            };

            if (isLocked) return <PinScreen onUnlock={(code) => {
                if(code === localStorage.getItem('xpense_pin')) setIsLocked(false);
                else alert('Incorrect PIN');
            }} />;

            if(loading) return <div className="h-screen bg-[var(--bg)] p-6"><Shimmer /></div>;
            if(!user) return (
                <div className="h-full flex flex-col items-center justify-center p-8 page-enter">
                    <div className="w-24 h-24 neu-icon rounded-3xl flex items-center justify-center mb-8">
                        <img src={LOGO} className="w-16 drop-shadow-lg" />
                    </div>
                    <h1 className="text-3xl font-black text-[var(--blue)] mb-1">XpenseFlow Pro</h1>
                    <button onClick={()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())} className="w-full py-4 neu-btn flex items-center justify-center gap-3 text-[var(--text-main)] font-bold mt-10">
                        <i className="fab fa-google text-[var(--blue)]"></i> Sign In with Google
                    </button>
                </div>
            );

            return (
                <div className="h-full flex flex-col">
                    <div className="flex-1 overflow-y-auto p-6 pb-40 scroll-container hide-scrollbar">
                        {view === 'home' && <Dashboard user={user} transactions={txs} settings={settings} goals={goals} setView={setView} />}
                        {view === 'subscriptions' && <SubscriptionView subscriptions={subscriptions} onAdd={addSub} onDelete={delSub} settings={settings} />}
                        {view === 'history' && <HistoryView transactions={txs} settings={settings} onDelete={delTx} />}
                        {view === 'settings' && <SettingsView settings={settings} onUpdate={setSettings} user={user} />}
                    </div>

                    {/* Navigation */}
                    <div className="fixed bottom-0 left-0 w-full h-24 frosted-nav z-50 flex items-center justify-between px-6 pb-2">
                        <button onClick={()=>setView('home')} className={`p-3 rounded-2xl transition-all ${view==='home' ? 'text-[var(--blue)] bg-[var(--bg)] shadow-inner' : 'text-[var(--text-sub)]'}`}>
                            <i className="fas fa-home text-xl"></i>
                        </button>
                        <button onClick={()=>setView('subscriptions')} className={`p-3 rounded-2xl transition-all ${view==='subscriptions' ? 'text-[var(--blue)] bg-[var(--bg)] shadow-inner' : 'text-[var(--text-sub)]'}`}>
                            <i className="fas fa-file-invoice-dollar text-xl"></i>
                        </button>
                        <button onClick={()=>setModalOpen(true)} className="w-16 h-16 rounded-full fab-main flex items-center justify-center text-white text-2xl active:scale-95 transition-transform">
                            <i className="fas fa-plus"></i>
                        </button>
                        <button onClick={()=>setView('history')} className={`p-3 rounded-2xl transition-all ${view==='history' ? 'text-[var(--blue)] bg-[var(--bg)] shadow-inner' : 'text-[var(--text-sub)]'}`}>
                            <i className="fas fa-history text-xl"></i>
                        </button>
                        <button onClick={()=>setView('settings')} className={`p-3 rounded-2xl transition-all ${view==='settings' ? 'text-[var(--blue)] bg-[var(--bg)] shadow-inner' : 'text-[var(--text-sub)]'}`}>
                            <i className="fas fa-cog text-xl"></i>
                        </button>
                    </div>

                    {/* Add Modal */}
                    {modalOpen && (
                        <div className="fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm flex items-end justify-center" onClick={()=>setModalOpen(false)}>
                            <div className="w-full max-w-md bg-[var(--bg)] rounded-t-[40px] p-8 pb-10 shadow-2xl relative page-enter" onClick={e=>e.stopPropagation()}>
                                {aiLoading && <div className="absolute inset-0 z-50 bg-[var(--bg)] opacity-90 rounded-t-[40px] flex items-center justify-center font-black text-[var(--blue)] animate-pulse">AI PROCESSING...</div>}
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-black text-[var(--blue)]">New Entry</h2>
                                    <div className="flex gap-2">
                                        <button onClick={()=>fileRef.current.click()} className="w-10 h-10 neu-btn text-[var(--blue)] flex items-center justify-center"><i className="fas fa-camera"></i></button>
                                        <button onClick={()=>setModalOpen(false)} className="w-10 h-10 neu-btn text-[var(--red)] flex items-center justify-center"><i className="fas fa-times"></i></button>
                                        <input type="file" ref={fileRef} className="hidden" accept="image/*" onChange={handleOCR} />
                                    </div>
                                </div>
                                <div className="space-y-5">
                                    <div className="flex p-1 neu-pressed rounded-2xl">
                                        <button onClick={()=>setNewType('EXPENSE')} className={`flex-1 py-3 rounded-xl font-black transition-all ${newType==='EXPENSE'?'bg-[var(--bg)] shadow-lg text-[var(--red)]':'text-[var(--text-sub)]'}`}>Expense</button>
                                        <button onClick={()=>setNewType('INCOME')} className={`flex-1 py-3 rounded-xl font-black transition-all ${newType==='INCOME'?'bg-[var(--bg)] shadow-lg text-[var(--green)]':'text-[var(--text-sub)]'}`}>Income</button>
                                    </div>
                                    <input placeholder="Title" value={newTitle} onChange={e=>setNewTitle(e.target.value)} className="w-full p-4 neu-pressed rounded-2xl font-bold bg-transparent outline-none text-[var(--text-main)]" />
                                    <div className="flex gap-3">
                                        <input type="number" placeholder="0.00" value={newAmount} onChange={e=>setNewAmount(e.target.value)} className="flex-1 p-4 neu-pressed rounded-2xl font-black text-xl bg-transparent outline-none text-[var(--text-main)]" />
                                        <select value={newCat} onChange={e=>setNewCat(e.target.value)} className="w-1/3 p-4 neu-pressed rounded-2xl font-bold text-xs bg-transparent outline-none text-[var(--text-main)]">
                                            {CATEGORIES.map(c=><option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                    <button onClick={handleAdd} className="w-full py-4 bg-[var(--blue)] text-white font-black rounded-2xl shadow-lg active:scale-95 transition-transform tracking-widest">SAVE ENTRY</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>