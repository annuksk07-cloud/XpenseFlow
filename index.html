
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XpenseFlow - Receipt & Expense Tracker</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome (for icons) CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Chart.js (for analytics) CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
        background-color: #efeeee;
        color: #4a5568;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: #efeeee; }
      ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
      /* Hide number input spinners */
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
      }
      input[type=number] { -moz-appearance: textfield; }
      /* Custom animation classes for modals/toasts */
      @keyframes slide-in-from-top {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      @keyframes slide-in-from-bottom {
        from { transform: translateY(50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      @keyframes fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .animate-in { animation-duration: 300ms; animation-timing-function: ease-out; animation-fill-mode: forwards; }
      .slide-in-from-top { animation-name: slide-in-from-top; }
      .slide-in-from-bottom { animation-name: slide-in-from-bottom; }
      .fade-in { animation-name: fade-in; }
    </style>
<script type="importmap">
{
  "imports": {
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script>
    window.onload = function() {
      // --- START OF CONSOLIDATED JAVASCRIPT LOGIC ---

      // 1. --- ENUMS, CONSTANTS, AND TYPES (from types.ts) ---
      const TransactionType = { INCOME: 'INCOME', EXPENSE: 'EXPENSE' };
      const PaymentMethod = { CASH: 'CASH', CARD: 'CARD', WALLET: 'WALLET', TRANSFER: 'TRANSFER' };
      const CURRENCIES = {
          USD: { symbol: '$', rate: 1 }, EUR: { symbol: '€', rate: 0.92 },
          GBP: { symbol: '£', rate: 0.79 }, INR: { symbol: '₹', rate: 83.5 },
          JPY: { symbol: '¥', rate: 150.0 }
      };
      const CATEGORY_TAGS = {
          Food: ['#Groceries', '#DiningOut', '#Snacks'], Transport: ['#Fuel', '#Uber', '#PublicTransport'],
          Shopping: ['#Clothing', '#Electronics', '#Home'], Bills: ['#Rent', '#Utilities', '#Internet'],
          Entertainment: ['#Movies', '#Games', '#Subscriptions'], Health: ['#Pharmacy', '#Doctor', '#Gym'],
          Salary: ['#Bonus', '#Freelance'], Investment: ['#Stocks', '#Crypto']
      };
      const STORAGE_KEY = 'expense_tracker_transactions';
      const SETTINGS_KEY = 'expense_tracker_settings';
      const AUTO_LOCK_TIMEOUT_MS = 60000;

      // 2. --- APPLICATION STATE & CORE LOGIC (from useTransactions.ts) ---
      let state = {
          transactions: [],
          settings: {
              budgetLimit: 2000, savingsGoal: 5000, baseCurrency: 'USD', isPrivacyMode: false
          },
          stats: { totalBalance: 0, totalIncome: 0, totalExpense: 0, burnRate: 0, projectedSpend: 0, totalTax: 0 },
          toasts: [],
          isModalOpen: false,
          isSettingsOpen: false,
          isLocked: false,
          isBlurred: false,
      };
      
      let chartInstance = null; // To hold the Chart.js instance

      const rootElement = document.getElementById('root');
      if (!rootElement) {
        console.error("Fatal Error: Root element not found.");
        document.body.innerHTML = "<h1>Error: Application failed to load. Root element missing.</h1>";
        return;
      }

      // --- Utility Functions ---
      const generateUUID = () => {
          if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
              const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
              return v.toString(16);
          });
      };
      
      const sanitizeHTML = (str) => {
        const temp = document.createElement('div');
        temp.textContent = str;
        return temp.innerHTML;
      };

      // --- State Management & Data Persistence ---
      const setState = (newState) => {
          Object.assign(state, newState);
          renderApp();
      };
      
      const saveState = () => {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state.transactions));
          localStorage.setItem(SETTINGS_KEY, JSON.stringify(state.settings));
      };
      
      const loadState = () => {
          try {
              const savedTrans = localStorage.getItem(STORAGE_KEY);
              const savedSettings = localStorage.getItem(SETTINGS_KEY);
              if (savedTrans) state.transactions = JSON.parse(savedTrans);
              if (savedSettings) state.settings = { ...state.settings, ...JSON.parse(savedSettings) };
          } catch (e) {
              console.error("Failed to parse from localStorage", e);
              // Reset to default if data is corrupted
              localStorage.removeItem(STORAGE_KEY);
              localStorage.removeItem(SETTINGS_KEY);
          }
      };

      const calculateStats = () => {
          const initialStats = { totalBalance: 0, totalIncome: 0, totalExpense: 0, burnRate: 0, projectedSpend: 0, totalTax: 0 };
          const calculatedStats = state.transactions.reduce((acc, curr) => {
              const amount = Number(curr.amount);
              if (curr.type === TransactionType.INCOME) {
                  acc.totalIncome += amount;
                  acc.totalBalance += amount;
              } else {
                  acc.totalExpense += amount;
                  acc.totalBalance -= amount;
                  if (curr.hasTax && curr.taxAmount) acc.totalTax += Number(curr.taxAmount);
              }
              return acc;
          }, initialStats);

          calculatedStats.totalBalance = Math.round(calculatedStats.totalBalance * 100) / 100;
          
          const today = new Date();
          const dayOfMonth = today.getDate();
          const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
          const currentMonthExpenses = state.transactions
              .filter(t => t.type === TransactionType.EXPENSE && new Date(t.date).getMonth() === today.getMonth())
              .reduce((sum, t) => sum + t.amount, 0);

          calculatedStats.burnRate = dayOfMonth > 0 ? currentMonthExpenses / dayOfMonth : 0;
          calculatedStats.projectedSpend = calculatedStats.burnRate * daysInMonth;
          
          state.stats = calculatedStats;
      };
      
      // --- Transaction & Settings Actions ---
      const addToast = (message, type = 'info') => {
        const id = generateUUID();
        state.toasts.push({ id, message, type });
        renderApp();
        setTimeout(() => removeToast(id), 3000);
      };

      const removeToast = (id) => {
        state.toasts = state.toasts.filter(t => t.id !== id);
        renderApp();
      };

      const convertCurrency = (amount, from, to) => {
          const fromRate = CURRENCIES[from]?.rate || 1;
          const toRate = CURRENCIES[to]?.rate || 1;
          return (amount / fromRate) * toRate;
      };

      const addTransaction = (transactionData) => {
          const baseAmount = convertCurrency(transactionData.originalAmount, transactionData.currency, state.settings.baseCurrency);
          const newTransaction = {
              ...transactionData,
              amount: baseAmount,
              id: generateUUID(),
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString(),
          };
          state.transactions.unshift(newTransaction);
          calculateStats();
          saveState();
          addToast('Transaction added successfully', 'success');
          setState({ isModalOpen: false });
      };

      const deleteTransaction = (id) => {
          state.transactions = state.transactions.filter(t => t.id !== id);
          calculateStats();
          saveState();
          addToast('Transaction removed', 'info');
          renderApp(); // Force re-render
      };
      
      const updateSettings = (newSettings) => {
          state.settings = { ...state.settings, ...newSettings };
          calculateStats(); // Recalculate stats if currency changes
          saveState();
          renderApp();
      };

      const exportToCSV = () => {
          const headers = ['Date', 'Title', 'Category', 'Amount (Base)', 'Currency', 'Type', 'Payment Method', 'Has Tax', 'Tax Amount', 'Created At'];
          const rows = state.transactions.map(t => [
              t.date, `"${t.title}"`, t.category, t.amount.toFixed(2), t.currency, t.type,
              t.paymentMethod || 'N/A', t.hasTax ? 'Yes' : 'No', t.taxAmount || 0, t.createdAt || ''
          ].join(','));
          const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows].join('\n');
          const link = document.createElement("a");
          link.setAttribute("href", encodeURI(csvContent));
          link.setAttribute("download", `xpenseflow_audit_${new Date().toISOString().split('T')[0]}.csv`);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          addToast('Audit Report downloaded', 'success');
      };
      
      const backupData = () => {
          const backup = { settings: state.settings, transactions: state.transactions, timestamp: new Date().toISOString() };
          const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup, null, 2));
          const link = document.createElement('a');
          link.setAttribute("href", dataStr);
          link.setAttribute("download", `xpenseflow_backup.json`);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          addToast('Backup saved successfully', 'success');
      };
      
      // 3. --- COMPONENT TEMPLATES (HTML strings) ---
      const getIcon = (iconName) => `<i class="fa-solid fa-${iconName}"></i>`;
      const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: state.settings.baseCurrency }).format(amount);

      const DashboardComponent = () => {
          const { stats, settings } = state;
          const currencySymbol = CURRENCIES[settings.baseCurrency]?.symbol || '$';
          const privacyClass = settings.isPrivacyMode ? 'filter blur-md select-none' : '';

          return `
            <div class="p-6 rounded-3xl bg-[#efeeee] shadow-[10px_10px_20px_#c5c5c5,-10px_-10px_20px_#ffffff] mb-8 relative group">
              <div class="absolute top-4 right-4">
                <button onclick="window.app.toggleSettings(true)" class="p-2 rounded-full text-gray-400 hover:text-blue-500" title="App Settings">
                    <i class="fa-solid fa-gear text-lg"></i>
                </button>
              </div>
              <div class="text-center mb-6 mt-2">
                <h2 class="text-gray-500 font-medium text-sm tracking-wider uppercase mb-2">Total Balance</h2>
                <div class="flex items-center justify-center gap-2 text-4xl font-bold text-gray-700 transition-all duration-300 ${privacyClass}">
                  ${getIcon('wallet')}
                  <span>${formatCurrency(stats.totalBalance)}</span>
                </div>
              </div>
              <div class="flex justify-between gap-4">
                <div class="flex-1 p-4 rounded-2xl bg-[#efeeee] shadow-[inset_5px_5px_10px_#d1d1d1,inset_-5px_-5px_10px_#ffffff] flex flex-col items-center">
                  <div class="flex items-center gap-1 mb-1 text-green-600">${getIcon('arrow-trend-up')} <span class="text-xs font-bold uppercase">Income</span></div>
                  <span class="text-lg font-bold text-gray-700 transition-all duration-300 ${privacyClass}">${formatCurrency(stats.totalIncome)}</span>
                </div>
                <div class="flex-1 p-4 rounded-2xl bg-[#efeeee] shadow-[inset_5px_5px_10px_#d1d1d1,inset_-5px_-5px_10px_#ffffff] flex flex-col items-center">
                  <div class="flex items-center gap-1 mb-1 text-red-500">${getIcon('arrow-trend-down')} <span class="text-xs font-bold uppercase">Expense</span></div>
                  <span class="text-lg font-bold text-gray-700 transition-all duration-300 ${privacyClass}">${formatCurrency(stats.totalExpense)}</span>
                </div>
              </div>
            </div>
          `;
      };
      
      const FinancialHealthComponent = () => {
          const { stats, settings } = state;
          const savingsRate = stats.totalIncome > 0 ? ((stats.totalIncome - stats.totalExpense) / stats.totalIncome) * 100 : 0;
          const budgetUsage = (stats.totalExpense / settings.budgetLimit) * 100;
          const isDangerZone = budgetUsage > 80;

          return `
            <div class="mb-6">
              <h3 class="text-lg font-bold text-gray-700 px-2 mb-3">Financial Health</h3>
              <div class="grid grid-cols-2 gap-4">
                <div class="p-4 rounded-2xl bg-[#efeeee] shadow-[5px_5px_10px_#d1d1d1,-5px_-5px_10px_#ffffff] flex flex-col items-center text-center">
                   <div class="mb-2 p-3 rounded-full bg-[#efeeee] text-orange-500 shadow-[inset_3px_3px_6px_#c5c5c5,inset_-3px_-3px_6px_#ffffff]">
                     <i class="fa-solid fa-fire-flame-curved fa-lg ${savingsRate > 20 ? 'animate-pulse' : ''}"></i>
                   </div>
                   <span class="text-xs font-bold text-gray-500 uppercase">Savings Streak</span>
                   <span class="text-xl font-black text-gray-700">${savingsRate > 0 ? 'Active' : 'Inactive'}</span>
                   <span class="text-[10px] text-gray-400 mt-1">Keep saving > 20%</span>
                </div>
                <div class="p-4 rounded-2xl bg-[#efeeee] shadow-[5px_5px_10px_#d1d1d1,-5px_-5px_10px_#ffffff] flex flex-col items-center text-center">
                   <div class="mb-2 p-3 rounded-full bg-[#efeeee] text-blue-500 shadow-[inset_3px_3px_6px_#c5c5c5,inset_-3px_-3px_6px_#ffffff]">
                     <i class="fa-solid fa-gauge-high fa-lg"></i>
                   </div>
                   <span class="text-xs font-bold text-gray-500 uppercase">Health Score</span>
                   <span class="text-xl font-black text-gray-700">A+</span>
                   <span class="text-[10px] text-gray-400 mt-1">Based on spending</span>
                </div>
              </div>
              ${isDangerZone ? `
                <div class="mt-4 p-3 rounded-xl bg-[#efeeee] shadow-[inset_3px_3px_6px_#d1d1d1,inset_-3px_-3px_6px_#ffffff] border-l-4 border-red-500 flex items-start gap-3">
                  <i class="fa-solid fa-triangle-exclamation text-red-500 shrink-0 mt-0.5"></i>
                  <div>
                    <p class="text-xs font-bold text-gray-700">Budget Alert</p>
                    <p class="text-[10px] text-gray-500 leading-tight">
                      You've used ${budgetUsage.toFixed(0)}% of your monthly limit. Consider slowing down.
                    </p>
                  </div>
                </div>
              ` : ''}
            </div>
          `;
      };
      
      const AnalyticsComponent = () => {
          if (state.transactions.length === 0) return '';
          
          return `
            <div class="mb-8">
              <h3 class="text-lg font-bold text-gray-700 px-2 mb-4">Spend Analysis</h3>
              <div class="p-6 rounded-2xl bg-[#efeeee] shadow-[5px_5px_10px_#d1d1d1,-5px_-5px_10px_#ffffff] mb-6">
                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Last 7 Days</h4>
                <canvas id="analyticsChart" height="150"></canvas>
              </div>
            </div>
          `;
      };

      const TransactionListComponent = () => {
          // This component is complex and will be rendered by a dedicated function `renderTransactionList`
          return `<div id="transaction-list-container"></div>`;
      };
      
      const AddTransactionModalComponent = () => {
          if (!state.isModalOpen) return '';
          return `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm" id="modal-backdrop">
              <div class="w-full max-w-md bg-[#efeeee] rounded-3xl p-6 shadow-[20px_20px_60px_#bebebe,-20px_-20px_60px_#ffffff] relative animate-in fade-in max-h-[90vh] overflow-y-auto">
                <button onclick="window.app.toggleModal(false)" class="absolute top-4 right-4 w-12 h-12 flex items-center justify-center rounded-full bg-[#efeeee] shadow-[5px_5px_10px_#c5c5c5,-5px_-5px_10px_#ffffff] text-gray-500"><i class="fa-solid fa-xmark"></i></button>
                <div class="flex items-center justify-between mb-6 pr-12">
                   <h3 class="text-xl font-bold text-gray-700 pl-2">New Entry</h3>
                   <div id="voice-input-container"></div>
                </div>
                <form id="add-transaction-form" class="space-y-5">
                    <div class="flex p-1 rounded-xl bg-[#efeeee] shadow-[inset_5px_5px_10px_#d1d1d1,inset_-5px_-5px_10px_#ffffff]">
                      <button type="button" id="type-expense-btn" class="flex-1 py-4 rounded-lg font-bold text-sm">Expense</button>
                      <button type="button" id="type-income-btn" class="flex-1 py-4 rounded-lg font-bold text-sm">Income</button>
                    </div>
                    <div class="space-y-4">
                      <input name="title" type="text" placeholder="e.g. Groceries" required class="w-full px-4 py-3 bg-[#efeeee] rounded-xl outline-none text-gray-700 shadow-[inset_5px_5px_10px_#d1d1d1,inset_-5px_-5px_10px_#ffffff]" />
                      <div class="flex gap-3">
                         <input name="amount" type="number" placeholder="0.00" step="0.01" min="0" required class="flex-1 w-full px-4 py-3 bg-[#efeeee] rounded-xl outline-none text-gray-700 shadow-[inset_5px_5px_10px_#d1d1d1,inset_-5px_-5px_10px_#ffffff]" />
                         <select name="currency" class="w-1/3 px-4 py-3 bg-[#efeeee] rounded-xl outline-none text-gray-700 shadow-[inset_5px_5px_10px_#d1d1d1,inset_-5px_-5px_10px_#ffffff]">
                           ${Object.keys(CURRENCIES).map(c => `<option value="${c}">${c}</option>`).join('')}
                         </select>
                      </div>
                      <select name="category" class="w-full px-4 py-3 bg-[#efeeee] rounded-xl outline-none text-gray-700 shadow-[inset_5px_5px_10px_#d1d1d1,inset_-5px_-5px_10px_#ffffff]">
                         <option>General</option>
                         ${Object.keys(CATEGORY_TAGS).map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                      </select>
                    </div>
                    <button type="submit" class="w-full py-4 rounded-xl bg-[#efeeee] text-blue-500 font-bold shadow-[6px_6px_12px_#c5c5c5,-6px_-6px_12px_#ffffff] flex items-center justify-center gap-2">${getIcon('check')} Save Transaction</button>
                </form>
              </div>
            </div>`;
      };
      
      const SettingsModalComponent = () => {
          if (!state.isSettingsOpen) return '';
          return `
            <div class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/20 backdrop-blur-sm" id="settings-backdrop">
              <div class="w-full max-w-md bg-[#efeeee] rounded-t-3xl sm:rounded-3xl p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] animate-in slide-in-from-bottom">
                <div class="flex items-center justify-between mb-8">
                  <h3 class="text-xl font-bold text-gray-700">App Settings</h3>
                  <button onclick="window.app.toggleSettings(false)" class="w-11 h-11 flex items-center justify-center rounded-full bg-[#efeeee] shadow-[3px_3px_6px_#c5c5c5,-3px_-3px_6px_#ffffff] text-gray-500"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="space-y-6">
                  <div>
                    <div class="flex items-center gap-2 mb-2 text-gray-600">${getIcon('globe')} <span class="font-bold text-sm">Base Currency</span></div>
                    <div class="flex gap-2 overflow-x-auto pb-2">
                      ${Object.keys(CURRENCIES).map(code => `
                        <button onclick="window.app.updateSettings({ baseCurrency: '${code}' })" class="px-4 py-3 rounded-lg font-bold text-xs ${state.settings.baseCurrency === code ? 'bg-[#efeeee] text-blue-500 shadow-[inset_3px_3px_6px_#d1d1d1,inset_-3px_-3px_6px_#ffffff]' : 'text-gray-500 shadow-[3px_3px_6px_#d1d1d1,-3px_-3px_6px_#ffffff]'}">
                          ${code}
                        </button>
                      `).join('')}
                    </div>
                  </div>
                  <div class="flex items-center justify-between p-4 rounded-xl bg-[#efeeee] shadow-[5px_5px_10px_#d1d1d1,-5px_-5px_10px_#ffffff]">
                     <div class="flex items-center gap-3"><div class="p-2 rounded-full bg-[#efeeee] text-purple-500 shadow-[inset_2px_2px_4px_#c5c5c5,inset_-2px_-2px_4px_#ffffff]">${getIcon('lock')}</div><div><p class="font-bold text-sm text-gray-700">Stealth Mode</p><p class="text-[10px] text-gray-400">Blur sensitive numbers</p></div></div>
                     <button onclick="window.app.updateSettings({ isPrivacyMode: !${state.settings.isPrivacyMode} })" class="w-12 h-6 rounded-full relative ${state.settings.isPrivacyMode ? 'bg-blue-500' : 'bg-gray-300'}"><div class="absolute top-1 w-4 h-4 rounded-full bg-white shadow-sm transition-all duration-300 ${state.settings.isPrivacyMode ? 'left-7' : 'left-1'}"></div></button>
                  </div>
                  <div class="space-y-3 pt-2">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Data & Backup</h4>
                    <button onclick="window.app.exportToCSV()" class="w-full flex items-center justify-between p-4 rounded-xl bg-[#efeeee] shadow-[3px_3px_6px_#d1d1d1,-3px_-3px_6px_#ffffff] text-gray-600">${getIcon('file-csv')} Export CSV</button>
                    <button onclick="window.app.backupData()" class="w-full flex items-center justify-between p-4 rounded-xl bg-[#efeeee] shadow-[3px_3px_6px_#d1d1d1,-3px_-3px_6px_#ffffff] text-gray-600">${getIcon('database')} Backup JSON</button>
                  </div>
                </div>
              </div>
            </div>`;
      };

      const ToastContainerComponent = () => `
        <div class="fixed top-6 left-1/2 -translate-x-1/2 z-[60] flex flex-col gap-2 w-full max-w-sm pointer-events-none px-4">
          ${state.toasts.map(toast => `
            <div class="pointer-events-auto flex items-center gap-3 bg-[#efeeee] px-4 py-3 rounded-xl shadow-[5px_5px_10px_#d1d1d1,-5px_-5px_10px_#ffffff] border-l-4 ${toast.type === 'success' ? 'border-green-500' : 'border-blue-500'} animate-in slide-in-from-top fade-in">
              ${getIcon(toast.type === 'success' ? 'check-circle' : 'info-circle')}
              <span class="text-sm font-bold text-gray-700">${sanitizeHTML(toast.message)}</span>
            </div>
          `).join('')}
        </div>`;

      // 4. --- DYNAMIC RENDERING FUNCTIONS ---
      const renderTransactionList = () => {
          const container = document.getElementById('transaction-list-container');
          if (!container) return;

          const currencySymbol = CURRENCIES[state.settings.baseCurrency]?.symbol || '$';
          const getCategoryIcon = (category) => {
              switch (category.toLowerCase()) {
                  case 'food': return getIcon('utensils'); case 'shopping': return getIcon('shopping-bag');
                  case 'transport': return getIcon('car'); case 'bills': return getIcon('home');
                  case 'entertainment': return getIcon('bolt'); case 'health': return getIcon('heartbeat');
                  case 'salary': return getIcon('dollar-sign'); case 'investment': return getIcon('briefcase');
                  default: return getIcon('dollar-sign');
              }
          };

          const listHTML = `
            <h3 class="text-lg font-bold text-gray-700 pl-2 mt-8">${state.transactions.length} Transaction${state.transactions.length !== 1 ? 's' : ''}</h3>
            ${state.transactions.length === 0 ? `
              <div class="text-center py-12 text-gray-400">
                <div class="w-16 h-16 rounded-full bg-[#efeeee] shadow-[5px_5px_10px_#c5c5c5,-5px_-5px_10px_#ffffff] flex items-center justify-center mx-auto mb-4">${getIcon('filter')}</div>
                <p>No transactions found</p>
              </div>` : 
              state.transactions.map(t => `
                <div class="group flex items-center justify-between p-4 rounded-2xl bg-[#efeeee] shadow-[5px_5px_10px_#d1d1d1,-5px_-5px_10px_#ffffff] mt-4">
                  <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-[inset_3px_3px_6px_#c5c5c5,inset_-3px_-3px_6px_#ffffff] ${t.type === TransactionType.INCOME ? 'text-green-600' : 'text-red-500'}">
                      ${getCategoryIcon(t.category)}
                    </div>
                    <div>
                      <p class="font-bold text-gray-700 text-sm">${sanitizeHTML(t.title)}</p>
                      <span class="text-xs text-gray-500">${new Date(t.date).toLocaleDateString()}</span>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="font-bold ${t.type === TransactionType.INCOME ? 'text-green-600' : 'text-red-500'}">
                      ${t.type === TransactionType.INCOME ? '+' : '-'}${currencySymbol}${Math.abs(t.amount).toFixed(2)}
                    </span>
                    <button onclick="window.app.deleteTransaction('${t.id}')" class="w-11 h-11 rounded-full flex items-center justify-center text-gray-400 hover:text-red-500">
                      ${getIcon('trash')}
                    </button>
                  </div>
                </div>
              `).join('')}
          `;
          container.innerHTML = listHTML;
      };

      const renderAnalyticsChart = () => {
          const ctx = document.getElementById('analyticsChart')?.getContext('2d');
          if (!ctx) return;
          
          if(chartInstance) {
              chartInstance.destroy(); // Destroy old chart to prevent memory leaks
          }

          const last7Days = [...Array(7)].map((_, i) => {
              const d = new Date(); d.setDate(d.getDate() - i);
              return d.toISOString().split('T')[0];
          }).reverse();

          const dailyTotals = last7Days.map(dateStr => {
              return state.transactions
                  .filter(t => t.type === TransactionType.EXPENSE && t.date.startsWith(dateStr))
                  .reduce((acc, t) => acc + Number(t.amount), 0);
          });
          
          chartInstance = new Chart(ctx, {
              type: 'bar',
              data: {
                  labels: last7Days.map(d => new Date(d).toLocaleDateString('en-US', { weekday: 'short' })),
                  datasets: [{
                      label: 'Daily Expense',
                      data: dailyTotals,
                      backgroundColor: 'rgba(59, 130, 246, 0.7)',
                      borderColor: 'rgba(59, 130, 246, 1)',
                      borderWidth: 1,
                      borderRadius: 4,
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: { legend: { display: false }, tooltip: { enabled: true } },
                  scales: { y: { beginAtZero: true, display: false }, x: { grid: { display: false } } }
              }
          });
      };
      
      const renderVoiceInput = () => {
        const container = document.getElementById('voice-input-container');
        if (!container) return;
        
        const isSupported = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
        if (!isSupported) {
            container.innerHTML = '';
            return;
        }

        container.innerHTML = `<button type="button" id="voice-btn" class="p-3 rounded-full bg-[#efeeee] text-gray-500 shadow-[5px_5px_10px_#d1d1d1,-5px_-5px_10px_#ffffff]"><i id="voice-icon" class="fa-solid fa-microphone"></i></button>`;
        const voiceBtn = document.getElementById('voice-btn');
        const voiceIcon = document.getElementById('voice-icon');
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';

        recognition.onstart = () => {
            voiceBtn.classList.add('bg-red-500', 'text-white', 'animate-pulse');
            voiceIcon.className = 'fa-solid fa-microphone-slash';
        };
        recognition.onend = () => {
            voiceBtn.classList.remove('bg-red-500', 'text-white', 'animate-pulse');
            voiceIcon.className = 'fa-solid fa-microphone';
        };
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            const form = document.getElementById('add-transaction-form');
            if(form){
                form.title.value = transcript.charAt(0).toUpperCase() + transcript.slice(1);
                const amountMatch = transcript.match(/(\d+(\.\d{1,2})?)/);
                if (amountMatch) form.amount.value = amountMatch[0];
            }
        };

        voiceBtn.onclick = () => {
            recognition.start();
        };
      };
      
      // 5. --- MAIN APP RENDER & EVENT BINDING ---
      const renderApp = () => {
          rootElement.innerHTML = `
              <div class="min-h-screen bg-[#efeeee] text-gray-800 font-sans transition-all duration-300 ${state.isBlurred ? 'blur-md' : ''}">
                <div id="toast-container"></div>
                <div class="max-w-md mx-auto min-h-screen flex flex-col relative shadow-[0_0_50px_rgba(0,0,0,0.05)]">
                  <header class="px-6 pt-8 pb-4 flex items-center justify-between">
                    <h1 class="text-2xl font-black text-gray-700 tracking-tight">Xpense<span class="text-blue-500">Flow</span></h1>
                    <div class="flex items-center gap-3">
                      ${state.settings.isPrivacyMode ? getIcon('lock') : ''}
                      <div class="w-10 h-10 rounded-full bg-[#efeeee] shadow-[5px_5px_10px_#c5c5c5,-5px_-5px_10px_#ffffff]"></div>
                    </div>
                  </header>
                  <main class="flex-1 px-6 overflow-y-auto">
                    ${DashboardComponent()}
                    ${FinancialHealthComponent()}
                    ${AnalyticsComponent()}
                    ${TransactionListComponent()}
                  </main>
                  <div class="fixed bottom-8 left-1/2 -translate-x-1/2 z-40">
                    <button onclick="window.app.toggleModal(true)" class="w-16 h-16 rounded-full bg-blue-500 text-white flex items-center justify-center shadow-[8px_8px_16px_#c5c5c5,-8px_-8px_16px_#ffffff]">
                      <i class="fa-solid fa-plus fa-2x"></i>
                    </button>
                  </div>
                  <div id="modal-container"></div>
                  <div id="settings-modal-container"></div>
                </div>
              </div>
          `;
          
          document.getElementById('toast-container').innerHTML = ToastContainerComponent();
          document.getElementById('modal-container').innerHTML = AddTransactionModalComponent();
          document.getElementById('settings-modal-container').innerHTML = SettingsModalComponent();

          // After main render, dynamically render complex components and bind events
          renderTransactionList();
          renderAnalyticsChart();
          
          if(state.isModalOpen){
             renderVoiceInput();
             document.getElementById('add-transaction-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                addTransaction({
                    title: data.title,
                    originalAmount: parseFloat(data.amount),
                    currency: data.currency,
                    type: document.querySelector('#type-expense-btn.bg-\\[\\#efeeee\\]') ? TransactionType.EXPENSE : TransactionType.INCOME,
                    category: data.category,
                    date: new Date().toISOString(),
                });
             });
             // Type toggle logic
             const expenseBtn = document.getElementById('type-expense-btn');
             const incomeBtn = document.getElementById('type-income-btn');
             const expenseStyle = "bg-[#efeeee] text-red-500 shadow-[5px_5px_10px_#bebebe,-5px_-5px_10px_#ffffff]";
             const incomeStyle = "bg-[#efeeee] text-green-600 shadow-[5px_5px_10px_#bebebe,-5px_-5px_10px_#ffffff]";
             const defaultStyle = "text-gray-400";
             expenseBtn.className = `flex-1 py-4 rounded-lg font-bold text-sm ${expenseStyle}`;
             incomeBtn.className = `flex-1 py-4 rounded-lg font-bold text-sm ${defaultStyle}`;
             
             expenseBtn.onclick = () => { 
                expenseBtn.className = `flex-1 py-4 rounded-lg font-bold text-sm ${expenseStyle}`;
                incomeBtn.className = `flex-1 py-4 rounded-lg font-bold text-sm ${defaultStyle}`;
             };
             incomeBtn.onclick = () => { 
                incomeBtn.className = `flex-1 py-4 rounded-lg font-bold text-sm ${incomeStyle}`;
                expenseBtn.className = `flex-1 py-4 rounded-lg font-bold text-sm ${defaultStyle}`;
             };
          }
      };
      
      // --- Global Event Handlers & App Initialization ---
      const AppController = {
          toggleModal: (isOpen) => setState({ isModalOpen: isOpen }),
          toggleSettings: (isOpen) => setState({ isSettingsOpen: isOpen }),
          deleteTransaction,
          updateSettings,
          exportToCSV,
          backupData,
      };
      
      window.app = AppController;

      loadState();
      calculateStats();
      renderApp();
    };
    </script>
</body>
</html>
