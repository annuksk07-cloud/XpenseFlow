<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>XpenseFlow - Professional Wealth Management</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIlhwZW5zZUZsb3ciLAogICJzaG9ydF9uYW1lIjogIlhwZW5zZUZsb3ciLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI0YwRjJGNSIsCiAgInRoZW1lX2NvbG9yIjogIiMxRTQwQUYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2lrLmltYWdla2l0LmlvLzEzcGNtcXF6bi8xMDAwMTY5MjM5LXJlbW92ZWJnLXByZXZpZXclMjAoMSkucG5nP3VwZGF0ZWRBdD0xNzY4MzQ5OTUzMTQ0IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#F0F2F5" />
    <link rel="icon" type="image/png" href="https://ik.imagekit.io/13pcmqqzn/1000169239-removebg-preview%20(1).png?updatedAt=1768349953144" />

    <!-- Performance: Defer Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <!-- React Core -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Feature Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --app-bg: #F0F2F5; --blue: #1E40AF; --text: #1A1C2E; --red: #EF4444; --green: #10B981; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; user-select: none; }
        body { background-color: var(--app-bg); font-family: 'Inter', sans-serif; min-height: 100dvh; width: 100vw; overflow: hidden; position: fixed; margin: 0; color: var(--text); }
        #root { height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Neumorphic Design System */
        .neu-flat { background: #F0F2F5; box-shadow: 10px 10px 20px #d1d9e6, -10px -10px 20px #ffffff; border-radius: 24px; border: 1px solid rgba(255,255,255,0.4); }
        .neu-pressed { background: #F0F2F5; box-shadow: inset 6px 6px 12px #d1d9e6, inset -6px -6px 12px #ffffff; border-radius: 20px; }
        .neu-btn { background: #F0F2F5; box-shadow: 6px 6px 12px #d1d9e6, -6px -6px 12px #ffffff; border-radius: 16px; transition: all 0.2s ease; }
        .neu-btn:active { box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff; transform: scale(0.98); }
        .neu-icon { background: linear-gradient(145deg, #ffffff, #dcdfe4); box-shadow: 5px 5px 10px #d1d9e6, -5px -5px 10px #ffffff; }
        
        /* Specialized Elements */
        .fab-main { background: #1E40AF; box-shadow: 0 10px 25px rgba(30, 64, 175, 0.4); border: 6px solid #F0F2F5; }
        .frosted-glass { background: rgba(240, 242, 245, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.5); }
        .scan-anim { position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: #1E40AF; box-shadow: 0 0 15px #1E40AF; animation: scanning 2s infinite; }
        @keyframes scanning { 0% { top: 0; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        
        /* Utilities */
        .shimmer { background: linear-gradient(90deg, #F0F2F5 25%, #e6e9f0 50%, #F0F2F5 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .blur-sensitive { filter: blur(8px); transition: filter 0.3s; }
        .page-enter { animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Gemini SDK -->
    <script type="module">
        import { GoogleGenAI } from 'https://esm.run/@google/genai';
        window.GoogleGenAI = GoogleGenAI;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONFIGURATION ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBhUgvyYF_6BJkexyQvCSCCC8wev8Cnxbw",
            authDomain: "kids-d0256.firebaseapp.com",
            projectId: "kids-d0256",
            storageBucket: "kids-d0256.appspot.com",
            messagingSenderId: "975392531560",
            appId: "1:975392531560:web:7b165f696b1bdc8f57f47dd"
        };
        
        // Initialize Firebase safely
        if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const db = firebase.firestore();
        db.enablePersistence().catch(() => {}); // Offline support

        const LOGO = "https://ik.imagekit.io/13pcmqqzn/1000169239-removebg-preview%20(1).png?updatedAt=1768349953144";
        const LANGUAGES = {
            en: { welcome: 'Welcome Back', balance: 'Net Worth', income: 'Income', expense: 'Expense', history: 'History', settings: 'Settings', budget: 'Monthly Budget Control', save: 'Commit Transaction', add: 'New Entry' },
            hi: { welcome: 'स्वागत हे', balance: 'कुल संपत्ति', income: 'आय', expense: 'व्यय', history: 'इतिहास', settings: 'सेटिंग्स', budget: 'मासिक बजट', save: 'सहेजें', add: 'नया जोड़ें' },
            es: { welcome: 'Bienvenido', balance: 'Patrimonio', income: 'Ingresos', expense: 'Gastos', history: 'Historial', settings: 'Ajustes', budget: 'Presupuesto', save: 'Guardar', add: 'Nueva Entrada' },
            fr: { welcome: 'Bienvenue', balance: 'Valeur Nette', income: 'Revenus', expense: 'Dépenses', history: 'Historique', settings: 'Paramètres', budget: 'Budget Mensuel', save: 'Sauvegarder', add: 'Nouvelle' }
        };
        const CURRENCIES = { USD: '$', INR: '₹', EUR: '€', GBP: '£', JPY: '¥' };
        const CATEGORIES = ["Food", "Transport", "Shopping", "Bills", "Entertainment", "Health", "Investment", "Salary"];

        // --- COMPONENTS ---

        const Shimmer = () => (
            <div className="p-8 space-y-6">
                <div className="h-48 neu-flat shimmer rounded-3xl"></div>
                <div className="flex gap-4">
                    <div className="flex-1 h-32 neu-flat shimmer rounded-3xl"></div>
                    <div className="flex-1 h-32 neu-flat shimmer rounded-3xl"></div>
                </div>
                <div className="h-64 neu-flat shimmer rounded-3xl"></div>
            </div>
        );

        const AuthScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (isSignup) => {
                setLoading(true);
                try {
                    if(isSignup) await auth.createUserWithEmailAndPassword(email, password);
                    else await auth.signInWithEmailAndPassword(email, password);
                } catch(e) { alert(e.message); }
                setLoading(false);
            };

            const googleLogin = async () => {
                try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } 
                catch(e) { alert(e.message); }
            };

            return (
                <div className="h-full flex flex-col items-center justify-center p-8 page-enter">
                    <div className="w-24 h-24 neu-icon rounded-3xl flex items-center justify-center mb-8">
                        <img src={LOGO} className="w-16 drop-shadow-lg" />
                    </div>
                    <h1 className="text-3xl font-black text-[#1E40AF] mb-1">XpenseFlow</h1>
                    <p className="text-xs font-bold text-gray-400 tracking-[0.2em] mb-10 uppercase">Wealth Operating System</p>
                    
                    <div className="w-full space-y-5">
                        <input type="email" placeholder="Email Access" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-4 neu-pressed outline-none text-gray-600 font-bold rounded-2xl" />
                        <input type="password" placeholder="Security Code" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-4 neu-pressed outline-none text-gray-600 font-bold rounded-2xl" />
                        
                        <div className="flex gap-4">
                            <button onClick={()=>handleAuth(false)} className="flex-1 py-4 neu-btn text-[#1E40AF] font-black">{loading ? '...' : 'LOGIN'}</button>
                            <button onClick={()=>handleAuth(true)} className="flex-1 py-4 neu-btn text-gray-500 font-bold">JOIN</button>
                        </div>
                        
                        <div className="relative py-2">
                            <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-300"></div></div>
                            <div className="relative flex justify-center"><span className="bg-[#F0F2F5] px-2 text-xs text-gray-400 font-bold">OR</span></div>
                        </div>

                        <button onClick={googleLogin} className="w-full py-4 neu-btn flex items-center justify-center gap-3 text-gray-700 font-bold">
                            <i className="fab fa-google text-[#1E40AF]"></i> Continue with Google
                        </button>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, transactions, settings, lang }) => {
            const t = LANGUAGES[lang];
            const [insight, setInsight] = useState(null);
            
            const stats = useMemo(() => {
                return transactions.reduce((acc, t) => {
                    const amt = parseFloat(t.amount);
                    if (t.type === 'INCOME') { acc.inc += amt; acc.total += amt; }
                    else { acc.exp += amt; acc.total -= amt; }
                    return acc;
                }, { inc: 0, exp: 0, total: 0 });
            }, [transactions]);

            const budgetPercent = settings.budget ? Math.min((stats.exp / settings.budget) * 100, 100) : 0;
            const currency = CURRENCIES[settings.currency];

            // AI Insight Logic
            useEffect(() => {
                if(!window.GoogleGenAI || transactions.length === 0) return;
                const getInsight = async () => {
                    try {
                        const ai = new window.GoogleGenAI({ apiKey: process.env.API_KEY });
                        const res = await ai.models.generateContent({
                            model: 'gemini-3-flash-preview',
                            contents: `Analyze: Income ${stats.inc}, Expense ${stats.exp}. Top category: ${transactions[0]?.category}. Give 1 short, witty pro-tip (max 15 words) for a wealth dashboard.`
                        });
                        setInsight(res.text);
                    } catch(e) { console.log("AI Error", e.message); }
                };
                getInsight();
            }, [transactions.length]); // Only refresh on new tx

            // Chart Logic
            useEffect(() => {
                const ctx = document.getElementById('chart');
                if(!ctx) return;
                if(window.myChart) window.myChart.destroy();
                
                const last7 = transactions.slice(0, 7).reverse();
                window.myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: last7.map(t => new Date(t.date).getDate()),
                        datasets: [{
                            data: last7.map(t => t.type === 'EXPENSE' ? -t.amount : t.amount),
                            backgroundColor: last7.map(t => t.type === 'EXPENSE' ? '#EF4444' : '#10B981'),
                            borderRadius: 6
                        }]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { legend: { display: false } }, 
                        scales: { x: { display: false }, y: { display: false } } 
                    }
                });
            }, [transactions]);

            return (
                <div className="space-y-6 page-enter pb-24">
                    {/* Header */}
                    <div className="flex justify-between items-center px-2 pt-2">
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 neu-icon rounded-2xl flex items-center justify-center active:scale-95 transition-transform">
                                <img src={LOGO} className="w-7 h-7 object-contain" />
                            </div>
                            <div>
                                <h1 className="text-xl font-black text-[#1E40AF] tracking-tight">XpenseFlow</h1>
                                <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">{t.welcome} {user.email.split('@')[0]}</p>
                            </div>
                        </div>
                        <div className="w-10 h-10 neu-icon rounded-full flex items-center justify-center text-[#1E40AF] active:scale-95 transition-transform">
                            <i className="fas fa-bell"></i>
                        </div>
                    </div>

                    {/* Net Worth Card */}
                    <div className="neu-flat p-8 flex flex-col items-center justify-center relative overflow-hidden">
                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-[0.3em] mb-2">{t.balance}</p>
                        <h1 className={`text-4xl font-black text-gray-800 ${settings.stealth ? 'blur-sensitive' : ''}`}>
                            {currency}{stats.total.toLocaleString()}
                        </h1>
                        {insight && (
                            <div className="mt-4 px-4 py-2 bg-blue-50 rounded-xl border border-blue-100 text-xs font-medium text-blue-600 text-center animate-pulse">
                                <i className="fas fa-sparkles mr-1"></i> {insight}
                            </div>
                        )}
                    </div>

                    {/* Budget Control */}
                    <div className="neu-flat p-6">
                        <div className="flex justify-between mb-3">
                            <span className="text-xs font-bold text-gray-400 uppercase">{t.budget}</span>
                            <span className="text-xs font-black text-[#1E40AF]">{Math.round(budgetPercent)}%</span>
                        </div>
                        <div className="h-3 w-full neu-pressed rounded-full overflow-hidden">
                            <div className="h-full bg-[#1E40AF] transition-all duration-1000" style={{width: `${budgetPercent}%`}}></div>
                        </div>
                    </div>

                    {/* Income/Expense Grid */}
                    <div className="flex gap-5">
                        <div className="flex-1 neu-flat p-5 flex flex-col items-center">
                            <div className="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center mb-2 shadow-sm"><i className="fas fa-arrow-down"></i></div>
                            <span className="text-[10px] font-bold text-gray-400 uppercase">{t.income}</span>
                            <span className={`text-lg font-black text-green-600 ${settings.stealth ? 'blur-sensitive' : ''}`}>+{stats.inc > 1000 ? (stats.inc/1000).toFixed(1)+'k' : stats.inc}</span>
                        </div>
                        <div className="flex-1 neu-flat p-5 flex flex-col items-center">
                            <div className="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center mb-2 shadow-sm"><i className="fas fa-arrow-up"></i></div>
                            <span className="text-[10px] font-bold text-gray-400 uppercase">{t.expense}</span>
                            <span className={`text-lg font-black text-red-600 ${settings.stealth ? 'blur-sensitive' : ''}`}>-{stats.exp > 1000 ? (stats.exp/1000).toFixed(1)+'k' : stats.exp}</span>
                        </div>
                    </div>

                    {/* Chart */}
                    <div className="neu-flat p-6 h-48 flex items-end">
                        <canvas id="chart"></canvas>
                    </div>
                </div>
            );
        };

        const HistoryView = ({ transactions, settings, lang, onDelete }) => {
            const currency = CURRENCIES[settings.currency];
            if(transactions.length === 0) return <div className="h-full flex items-center justify-center text-gray-300 font-bold tracking-widest uppercase">No Data</div>;
            
            return (
                <div className="space-y-4 pb-24 page-enter">
                    <h2 className="text-2xl font-black text-[#1E40AF] mb-6 px-2">{LANGUAGES[lang].history}</h2>
                    {transactions.map(t => (
                        <div key={t.id} className="neu-flat p-5 flex items-center justify-between group">
                            <div className="flex items-center gap-4">
                                <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-xl shadow-inner ${t.type === 'INCOME' ? 'bg-green-50 text-green-500' : 'bg-red-50 text-red-500'}`}>
                                    <i className={`fas ${t.type === 'INCOME' ? 'fa-arrow-down' : 'fa-shopping-bag'}`}></i>
                                </div>
                                <div>
                                    <h4 className="font-bold text-gray-800">{t.title}</h4>
                                    <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">{t.category} • {new Date(t.date).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div className="flex flex-col items-end gap-1">
                                <span className={`font-black text-lg ${t.type === 'INCOME' ? 'text-green-500' : 'text-red-500'} ${settings.stealth ? 'blur-sensitive' : ''}`}>
                                    {t.type === 'INCOME' ? '+' : '-'}{currency}{t.amount}
                                </span>
                                <button onClick={()=>onDelete(t.id)} className="text-gray-300 hover:text-red-500 text-xs"><i className="fas fa-trash"></i></button>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const SettingsView = ({ settings, setSettings, lang, setLang, transactions, user }) => {
            const exportPDF = () => {
                const doc = new window.jspdf.jsPDF();
                doc.setFontSize(20);
                doc.text("XpenseFlow Wealth Report", 20, 20);
                doc.setFontSize(10);
                doc.text(`User: ${user.email} | Date: ${new Date().toLocaleDateString()}`, 20, 30);
                transactions.forEach((t, i) => {
                    doc.text(`${t.date.split('T')[0]} - ${t.title} - ${t.amount} ${settings.currency}`, 20, 40 + (i*10));
                });
                doc.save("xpenseflow_report.pdf");
            };

            const exportCSV = () => {
                const csv = "Date,Title,Amount,Type,Category\n" + transactions.map(t => `${t.date},${t.title},${t.amount},${t.type},${t.category}`).join("\n");
                const link = document.createElement("a");
                link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
                link.download = "xpenseflow_data.csv";
                link.click();
            };

            return (
                <div className="pb-24 space-y-8 page-enter">
                    <h2 className="text-2xl font-black text-[#1E40AF] px-2">{LANGUAGES[lang].settings}</h2>

                    <div className="neu-flat p-6 space-y-6">
                        {/* Language Grid */}
                        <div>
                            <label className="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-3">Language</label>
                            <div className="grid grid-cols-2 gap-4">
                                {Object.keys(LANGUAGES).map(l => (
                                    <button key={l} onClick={()=>setLang(l)} className={`py-3 rounded-xl font-bold transition-all ${lang === l ? 'neu-pressed text-[#1E40AF]' : 'bg-transparent text-gray-400'}`}>
                                        {l.toUpperCase()}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Currency Grid */}
                        <div>
                            <label className="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-3">Base Currency</label>
                            <div className="grid grid-cols-5 gap-2">
                                {Object.keys(CURRENCIES).map(c => (
                                    <button key={c} onClick={()=>setSettings({...settings, currency: c})} className={`py-2 rounded-lg font-bold text-xs ${settings.currency === c ? 'neu-pressed text-[#1E40AF]' : 'bg-transparent text-gray-400'}`}>
                                        {c}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Stealth Mode */}
                        <div className="flex items-center justify-between p-4 neu-pressed rounded-xl">
                            <span className="font-bold text-gray-600">Stealth Mode</span>
                            <button onClick={()=>setSettings({...settings, stealth: !settings.stealth})} className={`w-12 h-6 rounded-full relative transition-colors ${settings.stealth ? 'bg-[#1E40AF]' : 'bg-gray-300'}`}>
                                <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${settings.stealth ? 'right-1' : 'left-1'}`}></div>
                            </button>
                        </div>
                    </div>

                    {/* Export Actions */}
                    <div className="grid grid-cols-2 gap-6">
                        <button onClick={exportCSV} className="neu-flat p-6 flex flex-col items-center gap-2 text-green-600">
                            <i className="fas fa-file-csv text-2xl"></i> <span className="text-xs font-bold">CSV</span>
                        </button>
                        <button onClick={exportPDF} className="neu-flat p-6 flex flex-col items-center gap-2 text-red-600">
                            <i className="fas fa-file-pdf text-2xl"></i> <span className="text-xs font-bold">PDF</span>
                        </button>
                    </div>

                    <button onClick={()=>auth.signOut()} className="w-full py-5 neu-btn text-red-500 font-black">LOGOUT SECURELY</button>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home');
            const [txs, setTxs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [modalOpen, setModalOpen] = useState(false);
            
            // App Settings State
            const [lang, setLang] = useState('en');
            const [settings, setSettings] = useState({ currency: 'USD', budget: 5000, stealth: false });

            // Inputs
            const [newTitle, setNewTitle] = useState('');
            const [newAmount, setNewAmount] = useState('');
            const [newType, setNewType] = useState('EXPENSE');
            const [newCat, setNewCat] = useState('Food');
            const [scanning, setScanning] = useState(false);
            const fileRef = useRef(null);

            useEffect(() => {
                auth.onAuthStateChanged(u => {
                    setUser(u);
                    if(u) {
                        db.collection('users').doc(u.uid).collection('txs').orderBy('date', 'desc')
                        .onSnapshot(s => setTxs(s.docs.map(d => ({id: d.id, ...d.data()}))));
                    }
                    setLoading(false);
                });
            }, []);

            const handleOCR = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setScanning(true);
                try {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = async () => {
                        const b64 = reader.result.split(',')[1];
                        const ai = new window.GoogleGenAI({ apiKey: process.env.API_KEY });
                        const res = await ai.models.generateContent({
                            model: 'gemini-3-flash-preview',
                            contents: { parts: [
                                { inlineData: { mimeType: file.type, data: b64 } },
                                { text: "Extract receipt data. Return JSON ONLY: {merchant: string, amount: number, category: string (Food,Transport,Shopping,Bills,Health,Entertainment,Investment,Salary)}" }
                            ]},
                            config: { responseMimeType: "application/json" }
                        });
                        const data = JSON.parse(res.text);
                        setNewTitle(data.merchant || 'Unknown');
                        setNewAmount(data.amount || '');
                        setNewCat(data.category || 'Food');
                        setScanning(false);
                    };
                } catch(err) { 
                    alert("OCR Failed: " + err.message); 
                    setScanning(false);
                }
            };

            const addTx = async () => {
                if(!newAmount || !newTitle) return;
                await db.collection('users').doc(user.uid).collection('txs').add({
                    title: newTitle, amount: parseFloat(newAmount), type: newType, category: newCat, date: new Date().toISOString()
                });
                setModalOpen(false); setNewTitle(''); setNewAmount('');
            };

            const deleteTx = async (id) => await db.collection('users').doc(user.uid).collection('txs').doc(id).delete();

            if(loading) return <div className="h-screen bg-[#F0F2F5] flex items-center justify-center"><Shimmer /></div>;
            if(!user) return <AuthScreen />;

            return (
                <div className="h-full flex flex-col">
                    <div className="flex-1 overflow-y-auto p-6 scroll-container hide-scrollbar">
                        {view === 'home' && <Dashboard user={user} transactions={txs} settings={settings} lang={lang} />}
                        {view === 'history' && <HistoryView transactions={txs} settings={settings} lang={lang} onDelete={deleteTx} />}
                        {view === 'settings' && <SettingsView settings={settings} setSettings={setSettings} lang={lang} setLang={setLang} transactions={txs} user={user} />}
                    </div>

                    {/* Navigation Bar */}
                    <div className="fixed bottom-0 w-full h-24 frosted-glass flex items-center justify-around pb-6 px-6 z-40">
                        <button onClick={()=>setView('home')} className={`flex flex-col items-center gap-1 ${view==='home'?'text-[#1E40AF]':'text-gray-400'}`}>
                            <i className="fas fa-home text-xl"></i>
                            <span className="text-[9px] font-black uppercase tracking-widest">{LANGUAGES[lang].home || 'Home'}</span>
                        </button>
                        
                        <button onClick={()=>setModalOpen(true)} className="w-16 h-16 rounded-full fab-main flex items-center justify-center text-white text-2xl -translate-y-8 active:scale-95 transition-transform">
                            <i className="fas fa-plus"></i>
                        </button>
                        
                        <button onClick={()=>view === 'settings' ? setView('history') : setView('settings')} className={`flex flex-col items-center gap-1 ${view!=='home'?'text-[#1E40AF]':'text-gray-400'}`}>
                            <i className={`fas fa-${view==='settings'?'history':'cog'} text-xl`}></i>
                            <span className="text-[9px] font-black uppercase tracking-widest">{view==='settings'?'History':'Settings'}</span>
                        </button>
                    </div>

                    {/* Add Modal */}
                    {modalOpen && (
                        <div className="fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-end justify-center" onClick={()=>setModalOpen(false)}>
                            <div className="w-full max-w-md bg-[#F0F2F5] rounded-t-[40px] p-8 pb-10 shadow-2xl relative page-enter" onClick={e=>e.stopPropagation()}>
                                {scanning && <div className="absolute inset-0 z-50 rounded-t-[40px] bg-[#F0F2F5]/90 flex flex-col items-center justify-center"><div className="w-full h-1 bg-blue-600 scan-anim"></div><p className="font-black text-blue-600 animate-pulse mt-4">AI ANALYZING RECEIPT...</p></div>}
                                
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-3xl font-black text-[#1E40AF]">New Entry</h2>
                                    <div className="flex gap-3">
                                        <button onClick={()=>fileRef.current.click()} className="w-12 h-12 neu-btn text-blue-600 flex items-center justify-center"><i className="fas fa-camera"></i></button>
                                        <button onClick={()=>setModalOpen(false)} className="w-12 h-12 neu-btn text-gray-400 flex items-center justify-center"><i className="fas fa-times"></i></button>
                                    </div>
                                    <input type="file" ref={fileRef} className="hidden" accept="image/*" onChange={handleOCR} />
                                </div>

                                <div className="space-y-6">
                                    <div className="flex p-1 neu-pressed rounded-2xl">
                                        <button onClick={()=>setNewType('EXPENSE')} className={`flex-1 py-3 rounded-xl font-black transition-all ${newType==='EXPENSE'?'bg-[#F0F2F5] shadow-lg text-red-500':'text-gray-400'}`}>Expense</button>
                                        <button onClick={()=>setNewType('INCOME')} className={`flex-1 py-3 rounded-xl font-black transition-all ${newType==='INCOME'?'bg-[#F0F2F5] shadow-lg text-green-500':'text-gray-400'}`}>Income</button>
                                    </div>

                                    <input placeholder="Transaction Title" value={newTitle} onChange={e=>setNewTitle(e.target.value)} className="w-full p-4 neu-pressed outline-none rounded-2xl font-bold bg-transparent" />
                                    
                                    <div className="flex gap-4">
                                        <input type="number" placeholder="0.00" value={newAmount} onChange={e=>setNewAmount(e.target.value)} className="flex-1 p-4 neu-pressed outline-none rounded-2xl font-black text-2xl text-gray-700 bg-transparent" />
                                        <select value={newCat} onChange={e=>setNewCat(e.target.value)} className="w-1/3 p-4 neu-pressed outline-none rounded-2xl font-bold text-xs bg-transparent">
                                            {CATEGORIES.map(c=><option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>

                                    <button onClick={addTx} className="w-full py-5 bg-[#1E40AF] text-white font-black rounded-2xl shadow-xl active:scale-95 transition-all tracking-widest uppercase">
                                        {LANGUAGES[lang].save}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>